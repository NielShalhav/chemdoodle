<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Molecule Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        #canvas {
            border: 1px solid black;
            display: block;
            margin: 0 auto;
            cursor: pointer;
        }
        .controls {
            margin: 20px 0;
        }
        .controls button {
            margin: 0 5px;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
        }
        .controls button.active {
            background-color: #4CAF50;
            color: white;
        }
        .atom-selector {
            margin: 20px 0;
        }
        #resultMessage {
            margin-top: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <h2>Simple Molecule Editor</h2>
    <canvas id="canvas" width="800" height="600"></canvas>
    <div class="controls">
        <button id="singleBond">Single Bond</button>
        <button id="doubleBond">Double Bond</button>
        <button id="tripleBond">Triple Bond</button>
        <button id="eraser">Eraser</button>
        <button id="checkButton">Check Molecule</button>
    </div>
    <div class="atom-selector">
        <label for="atom">Select Atom:</label>
        <select id="atom">
            <option value="H">H</option>
            <option value="C">C</option>
            <option value="O">O</option>
            <option value="N">N</option>
            <option value="F">F</option>
            <option value="Cl">Cl</option>
            <option value="Br">Br</option>
            <option value="I">I</option>
            <option value="S">S</option>
        </select>
    </div>
    <p id="resultMessage"></p>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let drawingMode = 'atom'; // Modes: atom, single, double, triple, erase
        let selectedAtom = 'C';
        let atoms = []; // Store atom positions
        let bonds = []; // Store bonds

        // Teacher-defined SMILES input for validation
        const teacherSMILES = "CO"; // Replace this SMILES string with the correct answer.

        // Atom radius
        const atomRadius = 15;

        // Event listeners for controls
        document.getElementById('atom').addEventListener('change', (e) => {
            selectedAtom = e.target.value;
            drawingMode = 'atom';
            setActiveButton(null);
        });

        document.getElementById('singleBond').addEventListener('click', () => activateBondMode('single'));
        document.getElementById('doubleBond').addEventListener('click', () => activateBondMode('double'));
        document.getElementById('tripleBond').addEventListener('click', () => activateBondMode('triple'));
        document.getElementById('eraser').addEventListener('click', () => activateBondMode('erase'));
        document.getElementById('checkButton').addEventListener('click', checkMolecule);

        // Activate bond mode and highlight the selected button
        function activateBondMode(mode) {
            drawingMode = mode;
            setActiveButton(mode);
        }

        function setActiveButton(mode) {
            document.querySelectorAll('.controls button').forEach(button => button.classList.remove('active'));
            if (mode) {
                document.getElementById(`${mode}Bond`).classList.add('active');
            }
        }

        // Event listener for canvas interaction
        canvas.addEventListener('click', (e) => {
            const x = e.offsetX;
            const y = e.offsetY;

            if (drawingMode === 'atom') {
                addOrReplaceAtom(x, y, selectedAtom);
            } else if (drawingMode === 'erase') {
                eraseElement(x, y);
            } else {
                addBondToAtom(x, y, drawingMode);
            }

            drawCanvas();
        });

        // Add or replace an atom
        function addOrReplaceAtom(x, y, element) {
            const atom = findAtomAtPosition(x, y);
            if (atom) {
                atom.element = element; // Replace the placeholder or existing atom
            } else {
                atoms.push({ x, y, element, bonds: [] });
            }
        }

        // Add a bond between two atoms
        function addBondToAtom(x, y, type) {
            const atom1 = findAtomAtPosition(x, y);
            if (!atom1) return;

            const atom2 = findNearestAtom(atom1.x, atom1.y);
            if (!atom2) return;

            bonds.push({
                atom1,
                atom2,
                type: type === 'single' ? 1 : type === 'double' ? 2 : 3,
            });

            atom1.bonds.push({ atom: atom2, type });
            atom2.bonds.push({ atom: atom1, type });
        }

        // Find atom at a given position
        function findAtomAtPosition(x, y) {
            return atoms.find(atom => isWithinRadius(atom.x, atom.y, x, y, atomRadius));
        }

        // Find the nearest atom to a given position
        function findNearestAtom(x, y) {
            let minDistance = Infinity;
            let nearestAtom = null;

            for (const atom of atoms) {
                const distance = Math.sqrt((x - atom.x) ** 2 + (y - atom.y) ** 2);
                if (distance < minDistance && distance <= 100) {
                    minDistance = distance;
                    nearestAtom = atom;
                }
            }

            return nearestAtom;
        }

        // Check if two points are within a certain radius
        function isWithinRadius(x1, y1, x2, y2, radius) {
            return Math.sqrt((x1 - x2) ** 2 + (y1 - y2) ** 2) <= radius;
        }

        // Erase an element
        function eraseElement(x, y) {
            const atom = findAtomAtPosition(x, y);
            if (atom) {
                atoms = atoms.filter(a => a !== atom);
                bonds = bonds.filter(b => b.atom1 !== atom && b.atom2 !== atom);
            }
        }

        // Draw the canvas
        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw bonds
            bonds.forEach(bond => {
                const { atom1, atom2, type } = bond;
                ctx.beginPath();
                ctx.moveTo(atom1.x, atom1.y);
                ctx.lineTo(atom2.x, atom2.y);
                ctx.lineWidth = type === 1 ? 2 : type === 2 ? 4 : 6;
                ctx.strokeStyle = 'black';
                ctx.stroke();
            });

            // Draw atoms
            atoms.forEach(atom => {
                ctx.beginPath();
                ctx.arc(atom.x, atom.y, atomRadius, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.stroke();
                ctx.fillStyle = 'black';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '16px Arial';
                ctx.fillText(atom.element, atom.x, atom.y);
            });
        }

        // Generate SMILES from the molecular structure
        function generateSMILES() {
            const visited = new Set();
            const smilesParts = [];

            function dfs(atom, parent) {
                if (visited.has(atom)) return;
                visited.add(atom);

                smilesParts.push(atom.element);

                atom.bonds.forEach(bond => {
                    if (bond.atom === parent) return;

                    const bondSymbol =
                        bond.type === 1 ? '-' : bond.type === 2 ? '=' : '#';
                    smilesParts.push(bondSymbol);
                    dfs(bond.atom, atom);
                });
            }

            if (atoms.length) dfs(atoms[0], null);
            return smilesParts.join('');
        }

        // Validate the molecule
        function checkMolecule() {
            const studentSMILES = generateSMILES();
            const resultMessage = document.getElementById('resultMessage');

            if (studentSMILES === teacherSMILES) {
                resultMessage.textContent = "Correct! The molecule matches the teacher's input.";
                resultMessage.style.color = "green";
            } else {
                resultMessage.textContent = `Incorrect. Your SMILES: ${studentSMILES}`;
                resultMessage.style.color = "red";
            }
        }

        drawCanvas();
    </script>
</body>
</html>
