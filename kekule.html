<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Molecule Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        #canvas {
            border: 1px solid black;
            display: block;
            margin: 0 auto;
            cursor: pointer;
        }
        .controls {
            margin: 20px 0;
        }
        .controls button {
            margin: 0 5px;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
        }
        .controls button.active {
            background-color: #4CAF50;
            color: white;
        }
        .atom-selector {
            margin: 20px 0;
        }
        #resultMessage {
            margin-top: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <h2>Simple Molecule Editor</h2>
    <canvas id="canvas" width="800" height="600"></canvas>
    <div class="controls">
        <button id="singleBond">Single Bond</button>
        <button id="doubleBond">Double Bond</button>
        <button id="tripleBond">Triple Bond</button>
        <button id="eraser">Eraser</button>
        <button id="checkButton">Check Molecule</button>
    </div>
    <div class="atom-selector">
        <label for="atom">Select Atom:</label>
        <select id="atom">
            <option value="H">H</option>
            <option value="C">C</option>
            <option value="O">O</option>
            <option value="N">N</option>
            <option value="F">F</option>
            <option value="Cl">Cl</option>
            <option value="Br">Br</option>
            <option value="I">I</option>
            <option value="S">S</option>
        </select>
    </div>
    <p id="resultMessage"></p>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let drawingMode = 'atom'; // Modes: atom, single, double, triple, erase
        let selectedAtom = 'C';
        let atoms = []; // Store atom positions
        let bonds = []; // Store bonds

        // Teacher-defined SMILES input for validation
        const teacherSMILES = "CO"; // Replace this SMILES string with the correct answer.

        // Atom radius
        const atomRadius = 15;

        // Event listeners for controls
        document.getElementById('atom').addEventListener('change', (e) => {
            selectedAtom = e.target.value;
            drawingMode = 'atom';
            setActiveButton(null);
        });

        document.getElementById('singleBond').addEventListener('click', () => activateBondMode('single'));
        document.getElementById('doubleBond').addEventListener('click', () => activateBondMode('double'));
        document.getElementById('tripleBond').addEventListener('click', () => activateBondMode('triple'));
        document.getElementById('eraser').addEventListener('click', () => activateBondMode('erase'));
        document.getElementById('checkButton').addEventListener('click', checkMolecule);

        // Activate bond mode and highlight the selected button
        function activateBondMode(mode) {
            drawingMode = mode;
            setActiveButton(mode);
        }

        function setActiveButton(mode) {
            document.querySelectorAll('.controls button').forEach(button => button.classList.remove('active'));
            if (mode) {
                document.getElementById(`${mode}Bond`).classList.add('active');
            }
        }

        // Event listener for canvas interaction
        canvas.addEventListener('click', (e) => {
            const x = e.offsetX;
            const y = e.offsetY;

            if (drawingMode === 'atom') {
                addOrReplaceAtom(x, y, selectedAtom);
            } else if (drawingMode === 'erase') {
                eraseElement(x, y);
            } else {
                addBondToAtom(x, y, drawingMode);
            }

            drawCanvas();
        });

        // Add or replace an atom
        function addOrReplaceAtom(x, y, element) {
            const atom = findAtomAtPosition(x, y);
            if (atom) {
                atom.element = element; // Replace the placeholder or existing atom
            } else {
                atoms.push({ x, y, element, bonds: [] });
            }
        }

        // Add a bond to an atom
        function addBondToAtom(x, y, type) {
            const atom = findAtomAtPosition(x, y);
            if (!atom) return;

            // Calculate positions for the bond
            const angle = Math.PI * (atom.bonds.length / 2); // Maximize bond angles
            const bondX = atom.x + Math.cos(angle) * 50;
            const bondY = atom.y + Math.sin(angle) * 50;

            // Reserve space for the new atom
            const newAtom = { x: bondX, y: bondY, element: '', bonds: [] };
            atoms.push(newAtom);

            // Link both atoms with the bond
            atom.bonds.push({ atom: newAtom, type });
            newAtom.bonds.push({ atom, type });
            bonds.push({ atom1: atom, atom2: newAtom, type });
        }

        // Erase an element
        function eraseElement(x, y) {
            atoms = atoms.filter(atom => !isWithinRadius(atom.x, atom.y, x, y, atomRadius));
            bonds = bonds.filter(bond => {
                return !(
                    isWithinRadius(bond.atom1.x, bond.atom1.y, x, y, atomRadius) ||
                    isWithinRadius(bond.atom2.x, bond.atom2.y, x, y, atomRadius)
                );
            });
        }

        // Find atom at a given position
        function findAtomAtPosition(x, y) {
            return atoms.find(atom => isWithinRadius(atom.x, atom.y, x, y, atomRadius));
        }

        // Check if two points are within a certain radius
        function isWithinRadius(x1, y1, x2, y2, radius) {
            return Math.sqrt((x1 - x2) ** 2 + (y1 - y2) ** 2) <= radius;
        }

        // Draw the canvas
        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw bonds
            bonds.forEach(bond => {
                const { atom1, atom2, type } = bond;
                const dx = atom2.x - atom1.x;
                const dy = atom2.y - atom1.y;
                const angle = Math.atan2(dy, dx);

                ctx.beginPath();
                ctx.moveTo(atom1.x, atom1.y);
                ctx.lineTo(atom2.x, atom2.y);
                ctx.lineWidth = type === 'single' ? 2 : type === 'double' ? 4 : 6;
                ctx.strokeStyle = 'black';
                ctx.stroke();

                // For double and triple bonds, draw parallel lines
                if (type === 'double' || type === 'triple') {
                    const offset = type === 'double' ? 5 : 10;
                    ctx.beginPath();
                    ctx.moveTo(atom1.x + Math.sin(angle) * offset, atom1.y - Math.cos(angle) * offset);
                    ctx.lineTo(atom2.x + Math.sin(angle) * offset, atom2.y - Math.cos(angle) * offset);
                    ctx.stroke();
                    if (type === 'triple') {
                        ctx.beginPath();
                        ctx.moveTo(atom1.x - Math.sin(angle) * offset, atom1.y + Math.cos(angle) * offset);
                        ctx.lineTo(atom2.x - Math.sin(angle) * offset, atom2.y + Math.cos(angle) * offset);
                        ctx.stroke();
                    }
                }
            });

            // Draw atoms
            atoms.forEach(atom => {
                ctx.beginPath();
                ctx.arc(atom.x, atom.y, atomRadius, 0, Math.PI * 2);
                ctx.fillStyle = atom.element ? 'white' : 'lightgray';
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.stroke();
                if (atom.element) {
                    ctx.fillStyle = 'black';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.font = '16px Arial';
                    ctx.fillText(atom.element, atom.x, atom.y);
                }
            });
        }

        // Generate SMILES (Improved logic)
        function generateSMILES() {
            const visited = new Set();
            const smiles = [];

            function dfs(atom) {
                if (!atom || visited.has(atom)) return;
                visited.add(atom);

                smiles.push(atom.element);

                atom.bonds.forEach(bond => {
                    const bondSymbol = bond.type === 'single' ? '-' : bond.type === 'double' ? '=' : '#';
                    if (!visited.has(bond.atom)) {
                        smiles.push(bondSymbol);
                        dfs(bond.atom);
                    }
                });
            }

            if (atoms.length) dfs(atoms[0]); // Start from the first atom
            return smiles.join('');
        }

        // Validate molecule
        function checkMolecule() {
            const resultMessage = document.getElementById('resultMessage');
            const studentSMILES = generateSMILES();
            console.log("Generated SMILES:", studentSMILES);

            if (studentSMILES === teacherSMILES) {
                resultMessage.textContent = "Correct! The molecule matches the teacher's input.";
                resultMessage.style.color = "green";
            } else {
                resultMessage.textContent = "Incorrect. Please revise the molecule.";
                resultMessage.style.color = "red";
            }
        }

        drawCanvas();
    </script>
</body>
</html>
